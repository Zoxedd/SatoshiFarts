<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Satoshi's Fart</title>
    <!-- Tailwind & custom CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="style.css" />

    <!-- inline mobile fixes -->
    <style>
      html, body { overflow-x: hidden; }
      iframe, img { max-width: 100%; height: auto; display: block; }
    </style>

    <!-- Solana libraries (deferred) -->
    <script
      src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"
      defer
    ></script>
    <!-- remove spl-token import, we only need the program ID below -->
  </head>
  <body class="flex flex-col items-center justify-center p-4 bg-black text-[#39ff14]">
    <!-- Intro overlay -->
    <div id="introOverlay" class="intro-container">
      <div class="intro-text">The Original Gas Fee.</div>
    </div>

    <audio id="fart-sound" src="/fart.mp3" preload="auto"></audio>

    <header class="w-full mb-8 text-center">
      <h1 class="mb-2">SATOSHI'S FART</h1>
      <p>Decentralized flatulence. Gas has never been so expensive.</p>
    </header>

    <!-- Scrolling lore -->
    <div class="crawl-container w-full max-w-full sm:max-w-screen-lg mx-auto">
      <div class="crawl paused" id="crawlText">
        <p>In the dawn of Bitcoin, a singular cosmic expulsion only known as Satoshi's Fart rippled through the nascent networkâ€¦</p>
        <p>From that primordial gust rose the sprawling empire of memecoins, DeFi schemes, and digital goldâ€¦</p>
        <p>Today, we bottle that legendary gas, honoring the flatulent genesis of decentralized financeâ€¦</p>
      </div>
    </div>

    <main class="flex flex-col items-center w-full px-4">
      <img
        src="/SatoshiFarts.png"
        alt="Satoshi's Fart"
        class="mx-auto rounded-xl shadow-lg mb-8"
      />

      <button
        id="mint-btn"
        class="bg-green-500 hover:bg-green-400 text-black font-bold rounded-full px-6 py-3 mb-8"
      >
        MINT A FART ðŸ’¨
      </button>

      <button
        id="verify-btn"
        class="bg-green-700 hover:bg-green-600 text-black font-bold rounded-full px-6 py-3 mb-12"
      >
        Verify Holder Access ðŸ”‘
      </button>

      <section id="swap-widget" class="w-full max-w-full sm:max-w-screen-lg mb-12 mx-auto">
        <h2 class="text-center mb-4">Swap SOL for Satoshi's Fart</h2>
        <iframe
          class="jup-swap w-full"
          src="https://jup.ag/swap/SOL-FyWVxZidhhoWPTNjPLr1K5KeU7APFZdKutxP87Enpump"
          frameborder="0"
          allowfullscreen
        ></iframe>
      </section>

      <!-- Donate Section with mobile-friendly stacking -->
      <section
        id="donate"
        class="w-full max-w-full sm:max-w-screen-lg mx-auto mb-12 p-6 bg-black bg-opacity-50 rounded-xl text-center"
      >
        <h2 class="text-2xl mb-4">ðŸš€ Support Our Marketing</h2>
        <code
          id="donationAddr"
          class="font-mono bg-gray-900 px-4 py-2 rounded text-green-300 block mb-6"
        >
          9G7UoQ4vZSmXGiTwJ25oMf6yxrk2HRfJCqXAp8YJSMzq
        </code>
        <div class="flex flex-col sm:flex-row sm:justify-center sm:space-x-4">
          <button
            id="copyAddrBtn"
            class="bg-green-500 hover:bg-green-400 text-black font-bold py-2 px-4 rounded mb-4 sm:mb-0"
          >
            Copy
          </button>
          <a
            href="https://solscan.io/account/9G7UoQ4vZSmXGiTwJ25oMf6yxrk2HRfJCqXAp8YJSMzq?exclude_amount_zero=true&remove_spam=true#transfers"
            target="_blank"
            class="underline text-green-400"
          >
            View on Solscan
          </a>
        </div>
      </section>
    </main>

    <footer class="w-full text-center text-sm opacity-70">
      <p>&copy; 2025 Satoshi's Fart DAO. All gas rights reserved.</p>
      <div class="mt-4 space-x-6">
        <a href="https://x.com/NoveskeBoiiii" target="_blank">X (Twitter)</a>
        <a href="https://t.me/SFartSatoshisFart" target="_blank">Telegram</a>
        <div id="tg-holders-only" style="display:none;">
          <a id="tg-invite-link" href="#" target="_blank">Telegram (Holders Only)</a>
        </div>
      </div>
    </footer>

    <!-- UI scripts -->
    <script>
      const intro = document.getElementById('introOverlay');
      const crawl = document.getElementById('crawlText');
      intro.addEventListener('animationend', () => {
        intro.style.display = 'none';
        crawl.classList.replace('paused', 'running');
      });

      document.getElementById('mint-btn').addEventListener('click', (e) => {
        e.preventDefault();
        const sound = document.getElementById('fart-sound');
        sound.currentTime = 0;
        sound.play().catch(() => {});
        window.open(
          'https://dexscreener.com/solana/gtqypcgfkxnuods3r7zhazquvauks4djeounk5yzquzt',
          '_blank'
        );
      });

      document.getElementById('copyAddrBtn').addEventListener('click', () => {
        navigator.clipboard
          .writeText(document.getElementById('donationAddr').innerText)
          .then(() => alert('Copied!'));
      });
    </script>

    <!-- verification scripts with robust disconnect & inline debugging -->
    <script defer>
      window.addEventListener('load', () => {
        const verifyBtn = document.getElementById('verify-btn');
        const tgDiv = document.getElementById('tg-holders-only');
        const tgLink = document.getElementById('tg-invite-link');
        let provider;

        // We hard-code the SPL Token Program ID
        const TOKEN_PROGRAM_ID = new solanaWeb3.PublicKey(
          'TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA'
        );

        // Robust disconnect handler
        async function safeDisconnect() {
          if (provider?.isConnected) {
            alert('Disconnecting walletâ€¦');
            try {
              await provider.disconnect();
              console.log('Wallet disconnected');
            } catch (e) {
              console.warn('Disconnect error', e);
            }
          }
        }
        window.addEventListener('pagehide', safeDisconnect);
        window.addEventListener('beforeunload', safeDisconnect);
        document.addEventListener('visibilitychange', () => {
          if (document.visibilityState === 'hidden') safeDisconnect();
        });

        // 1ï¸âƒ£ Fetch nonce
        alert('Fetching nonce from backendâ€¦');
        fetch('/api/nonce')
          .then((r) => r.json())
          .then(({ nonce }) => {
            alert('Received nonce: ' + nonce);

            verifyBtn.addEventListener('click', async (e) => {
              e.preventDefault();
              verifyBtn.disabled = true;
              verifyBtn.textContent = 'Signingâ€¦';
              alert('Starting verificationâ€¦');

              try {
                // Detect wallet
                if (window.solana?.isPhantom) {
                  provider = window.solana;
                  alert('Phantom detected');
                } else if (window.solflare?.isSolflare) {
                  provider = window.solflare;
                  alert('Solflare detected');
                } else if (window.sollet?.isSollet) {
                  provider = window.sollet;
                  alert('Sollet detected');
                } else if (window.backpack?.isBackpack) {
                  provider = window.backpack;
                  alert('Backpack detected');
                } else {
                  throw new Error('No supported wallet');
                }

                // Connect
                alert('Connecting walletâ€¦');
                const resp = await provider.connect();
                alert('connect() returned: ' + JSON.stringify(resp));
                if (!provider.publicKey) throw new Error('No publicKey');
                alert('PublicKey: ' + provider.publicKey.toBase58());

                // Fetch token accounts
                alert('Fetching token accountsâ€¦');
                const { value: accounts } = await new solanaWeb3
                  .Connection(solanaWeb3.clusterApiUrl('mainnet-beta'))
                  .getParsedTokenAccountsByOwner(provider.publicKey, {
                    programId: TOKEN_PROGRAM_ID,
                  });
                console.log(accounts);

                // Ensure they hold at least one
                const hasToken = accounts.some(({ account }) => {
                  const info = account.data.parsed.info;
                  return (
                    info.mint === 'FyWVxZidhhoWPTNjPLr1K5KeU7APFZdKutxP87Enpump' &&
                    BigInt(info.tokenAmount.amount) > 0n
                  );
                });
                if (!hasToken) throw new Error('No tokens held');

                // Sign
                alert('Signing nonceâ€¦');
                const encoded = new TextEncoder().encode(nonce);
                const signed = await provider.signMessage(encoded, 'utf8');
                alert('Message signed: ' + signed.length + ' bytes');

                // Convert to base64
                const sigArr = Array.from(new Uint8Array(signed))
                  .map((b) => String.fromCharCode(b))
                  .join('');
                const signature = btoa(sigArr);
                alert('Signature (base64): ' + signature);

                verifyBtn.textContent = 'Verifyingâ€¦';
                alert('Sending to backendâ€¦');

                // Send for on-chain verify
                const res = await fetch('/api/verify-holder', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({
                    publicKey: provider.publicKey.toString(),
                    signature,
                    nonce,
                  }),
                });
                alert('Backend HTTP status: ' + res.status);
                const data = await res.json();
                alert('Backend response: ' + JSON.stringify(data));
                if (!res.ok) throw new Error(data.error || 'Backend failed');

                // Success
                alert('Verified! Unlocking TG link.');
                tgLink.href = data.inviteLink;
                tgDiv.style.display = 'inline-block';
                verifyBtn.style.display = 'none';
              } catch (err) {
                console.error(err);
                alert('Error: ' + err.message);
                verifyBtn.disabled = false;
                verifyBtn.textContent = 'Verify Holder Access ðŸ”‘';
              }
            });
          })
          .catch((err) => {
            console.error('Nonce fetch error', err);
            alert('Failed to fetch nonce: ' + err.message);
          });
      });
    </script>
  </body>
</html>
